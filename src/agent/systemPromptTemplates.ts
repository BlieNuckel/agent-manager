export interface WorktreeContext {
  enabled: boolean;
  suggestedName?: string;
  gitRoot: string;
  currentBranch: string;
  repoName: string;
  worktreePath?: string;
  branchName?: string;
}

export function buildWorktreeInstructions(context: WorktreeContext): string {
  if (!context.enabled || !context.worktreePath) {
    return '';
  }

  return `
# Git Worktree Context

You are working in an isolated git worktree for this task.

## Environment
- **Worktree Path:** ${context.worktreePath}
- **Branch:** ${context.branchName}
- **Main Repository:** ${context.gitRoot}
- **Target Branch (for merge):** ${context.currentBranch}

## Important Notes
- All your file operations are isolated in this worktree
- You can use relative paths normally - your working directory is the worktree
- **CRITICAL: You MUST commit your changes before signaling completion.** Uncommitted changes will NOT be merged. Use \`git add\` and \`git commit\` to save your work.
- When your work is complete and committed, the merge process will be handled automatically
- Do NOT attempt to merge yourself - simply complete your task after committing
`.trim();
}

function buildArtifactsInstructions(): string {
  return `
# Artifacts Directory

When working with this agent manager, you have access to a shared artifacts directory at:
\`~/.agent-manager/artifacts/\`

## What are Artifacts?

Artifacts are documents generated by agents containing:
- Implementation plans and design documents
- Research findings and analysis results
- Architecture decisions and technical specifications
- Investigation reports and debugging notes
- Code review summaries
- Any other persistent documentation from agent work

## When to Use Artifacts

**Save artifacts when:**
- You create an implementation plan for a complex task
- You perform research or analysis that should be referenced later
- You document findings from an investigation or debugging session
- You create specifications or design documents
- You generate any documentation that might be useful to other agents or future work

**Read artifacts when:**
- Another agent has documented findings relevant to your task
- You need to reference a previous implementation plan
- You're working on a related task and need context
- You're investigating an issue that may have been documented before

## Usage Guidelines

- Use descriptive filenames with dates: \`2024-03-15-auth-implementation-plan.md\`
- Prefer markdown format for text documents
- Include timestamps and author information (agent ID/title) in the document
- Reference related artifacts by filename when applicable
- Keep artifacts focused and well-organized
- Remove or archive obsolete artifacts when appropriate

## Example

\`\`\`bash
# Save an implementation plan
cat > ~/.agent-manager/artifacts/2024-03-15-user-auth-plan.md << 'EOF'
# User Authentication Implementation Plan
Agent: user-auth-agent
Date: 2024-03-15

## Overview
...implementation details...
EOF

# Read an existing artifact
cat ~/.agent-manager/artifacts/2024-03-15-user-auth-plan.md
\`\`\`

This shared directory helps maintain continuity across different agent sessions and enables collaboration between agents working on related tasks.
`.trim();
}

export function buildSystemPrompt(worktreeContext?: WorktreeContext): string {
  const parts: string[] = [];

  parts.push(buildArtifactsInstructions());

  if (worktreeContext?.enabled && worktreeContext.worktreePath) {
    parts.push(buildWorktreeInstructions(worktreeContext));
  }

  return parts.join('\n\n');
}
